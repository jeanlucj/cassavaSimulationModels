---
title: "Simulation of IITA  Cassava Breeding Program"
author: 
  - name: "Moshood Agba Bakare"
    affiliation: "JeanLuc's Lab Cornell University"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{amsmath}
output:
  bookdown::html_document2:
    fig_caption: true
    number_sections: true
    df_print: paged
    mathjax: "default"
    highlight: kate
    toc: true
    toc_depth: 3
    #css: "my_style.css"
    toc_float:
      collapsed: false
      smooth_scroll: false
---


```{r setup, include=FALSE}
rm(list = ls())
# Configuring global parameters
knitr::opts_chunk$set(echo = TRUE, message = FALSE, error=FALSE, warning = FALSE,
                      fig.align = "center", fig.height = 6, fig.width = 6,
                      class.source = "lineAnchors")
```


```{r, include=FALSE, message=FALSE, error=FALSE, warning=FALSE}
#=======================================================================
# Packages
#=======================================================================
if (!require("pacman")) {
  install.packages("pacman")
}
# Include all packages here
pacman::p_load(
  AlphaSimR,
  RhpcBLASctl,
  rrBLUP,
  tidyverse,
  tidyr,
  tibble,
  here,
  prettycode,
  formattable
)
prettycode::prettycode()

# RhpcBLASctl::get_num_procs() # get number of cores
RhpcBLASctl::blas_set_num_threads(5)

#setwd("/Users/mab658/Documents/cassavaSimulationModels/analysis")
here::set_here()
```


# split genetic resources into two for two mega-environment

```{r}
# Define a function splitGen
# to split genetic resources for two mega-environments

splitGen <- function(pop){
  sample_size = floor(0.5*nInd(pop))
  set.seed(777)
  
  # randomly split data in r
  picked = sample(seq_len(nInd(pop)),size = sample_size)
  megaEnv1 <- pop[picked,] # individuals assigned to Mega Env1
  megaEnv2 <- pop[-picked,]# individuals assigned to Mega Env2
  return(list(me1=megaEnv1,me2=megaEnv2))
}

# load a function to generate simulated gxe data
# invoke GxE function
source("../code/gxeSim.R")
```

# This chunk set up global parameters for simulation, create founder genomes, populate breeding pipeline, and advance breeding program for 10 years of burn-in for each simulation replicate

```{r}

# Load global parameters
source("../code/globalParameters.R")

# Simulation runs for 10-year burn-in phase for xx replicates

for(REP in 1:nSimRun){

  cat("\n Simulation run:",REP,"of", nSimRun,"replication", "\n")

  # Create founder genomes and initial parents from founders haplotypes
  source("../code/createParents.R")

  # Fill/populate cassava breeding pipeline with unique individuals from initial parents
  source("../code/cassavaBreedingPipeline.R")

  # Run 10 years of burn-in by advancing years of breeding
  source("../code/burnin.R") # advance evaluation stages by years
}
```


# Future testing phase of breeding scenarios

# scenario 1:baseline - conventional breeding program ###

```{r}
for(REP in 1:nSimRun){ # loop over simulation replicates
  cat("\n Modeling Scenario 1 Conventional breeding program  (Conv) \n")
  cat("Simulation run:",REP,"of", nSimRun,"replicates", "\n")
  
  # load the burnin phase for the second scenario
  load(paste0("../data/burnin_",REP,".rda"))
  source("../code/conv.R")
}
```



# scenario 2: Broad adaptation breeding program

```{r}
for(REP in 1:nSimRun){
  
  cat("\n Modeling scenario 1 genomic selection at CET broad adaptation \n")
  
  cat("\n Simulation run:",REP,"of", nSimRun,"replication", "\n")
  
  # load the burnin phase for the second scenario
  load(paste0("../data/burnin_",REP,".rda"))
  
  # invoke the script to advance year of breeding for genomic selection
  source("../code/broadAdaptation.R")
}
```


# scenario 3: Narrow adaptation breeding program

```{r}
######### Simulate scenario 2: narrow adaptation breeding program ###############
for(REP in 1:nSimRun){
  cat("\n Modeling Scenario 2 narrow adaptation breeding program \n")
  cat("Simulation run:",REP,"of", nSimRun,"replication", "\n")
  
  # load the burnin phase for the second scenario
  load(paste0("../data/burnin_",REP,".rda"))
  
  source("../code/narrowAdaptation.R")
}
```


# bind and summary the raw simulated data

```{r}
scenarios = c("conv","broadGxE_parms", "narrowME1_parms","narrowME2_parms")

# Read in output simulated data
simData = vector("list",nSimRun*length(scenarios))
i = 0L
for(SCENARIO in scenarios){
  for(REP in 1:nSimRun){
    i = i+1L
    #FILE = paste0("simulated_data/",SCENARIO,"_",REP,".rds")
    #simData[[i]] = readRDS(FILE)
    FILE = paste0("../data/",SCENARIO,"_",REP,".csv")
    simData[[i]] = read.csv(FILE)
    
  }
}

# bind the data, compute mean and standard errors
simData = bind_rows(simData)
simData$year <- -(burninYears-1):burninYears


simSumm <- simData %>%
  dplyr::filter(year>=0) %>%
  group_by(scenario,year) %>%
  dplyr::summarise(
    gainMean = mean(gGain),
    relVarMean = mean(relVar),
    accurMean= mean(accuracy))
write.csv(simSumm,file="../output/simData.csv",row.names = FALSE)

simSumm$scenario <- as.factor(simSumm$scenario)
simSumm$scenario <- factor(simSumm$scenario,levels = c("Conv","Broad adaptation","Narrow adaptation"))
```


# plot of mean genetic value

```{r}
getwd()
gGainPlot <- ggplot(data=simSumm,aes(x=year,y=gainMean,color=scenario))+
  geom_point()+
  geom_line(size=1)+
  guides(scale="none")+
  theme_bw()+
  theme(legend.position = c(0.03,0.96),
        legend.justification = c("left","top"))+
  scale_x_continuous("Year",limits=c(0,10))+
  scale_y_continuous("Mean genetic value",limits=c(0,NA))

print(gGainPlot)

# save the plot to a file
ggsave("../output/geneticGain.jpeg",height=4.2, width=6.5, units="in", dpi=300)
```


# plot of mean relative variance of genetic value

```{r}
varGplot <- ggplot(data=simSumm,aes(x=year,y=relVarMean,color=scenario))+
  geom_point()+
  geom_line(size=1)+
  guides(scale="none")+
  theme_bw()+
  theme(legend.position = c(0.03,0.05),
        legend.justification = c("left","bottom"))+
  scale_x_continuous("Year",limits=c(0,10))+
  scale_y_continuous("Mean genetic variance",limits=c(0,NA))
print(varGplot)

# save the plot to a file
ggsave("../output/varGeneticGain.jpeg",height=4.2, width=6.5, units="in", dpi=300)
```


# plot of mean selection accuracy

```{r}
accurPlot <- ggplot(data=simSumm,aes(x=year,y=accurMean,color=scenario))+
  geom_point()+
geom_line(size=1)+
  guides(scale="none")+
  theme_bw()+
  theme(legend.position = c(0.98,0.95),
        legend.justification = c("right","top"))+
  scale_x_continuous("Year",limits=c(0,10))+
  scale_y_continuous("selection accuracy",limits=c(0,NA))

print(accurPlot)
```



